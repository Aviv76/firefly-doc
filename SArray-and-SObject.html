<!DOCTYPE html>
<html lang="en" class="js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="utf-8" />
    <meta name="keywords" content="">

    <title>SArray and SObject</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="assets/css/toc.css" />
    <link rel="stylesheet" href="assets/css/highlight.css" />
    <link rel="stylesheet" href="assets/css/prism.css" />
    <link rel="stylesheet" href="assets/css/prism-csdiff.css" />


    <link rel="stylesheet" href="assets/css/theme_firefly.css" />
    <link rel="stylesheet" href="assets/css/mermaid.css" />
</head>
<body class="markdown-body" role="document">

    <div class="wrapper">

        <div class="middle">

            <div class="container">

                <div class="content" role="navigation" aria-label="footer navigation">
                    <a id="previousButton" class="btn btn-neutral float-left" style="visibility:hidden">Previous</a> <a id="nextButton" class="btn btn-neutral float-right" style="visibility:hidden">Next</a>
                </div>
                <div class="content"><h1 id="sarray-and-sobject">SArray and SObject</h1>
<p>In our youtube channel, we’ve shown some basic web application writing that includes angular on the client side, and c# on the server side.</p>
<p>Here’s a link to that playlist:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/KB_NmAnfhRk?list=PL1DEQjXG2xnLvtE1-vUY_O6y_LLZfJ-KR" frameborder="0" allowfullscreen></iframe>
<p>In that video we’ve shown a class called SArray and SObject that reduces the need for poco objects to create the jsons required.</p>
<p>Here is the source for these classes.</p>
<p><strong>SArray.cs:</strong></p>
<p>This file includes the object model and everything required to create Json/XML/CSV. Note that it has only basic references – so it can, and should be placed in ENV.</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using Firefly.Box;
using Firefly.Box.Data.Advanced;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Web;
 
using System.Xml;
 
namespace Northwind.BasicAngular.Utils
{
    public class SObject : ISerializedObject
    {
        List&lt;Val&gt; _value = new List&lt;Val&gt;();
        public string ObjectType = "Object";
        public void Set(params ColumnBase[] cols)
        {
            foreach (var c in cols)
            {
                Set(c.Name, c.Value);
            }
 
        }
        public void Set(string name, object value)
        {
            Text txt;
            Number n;
            Date d;
            Time t;
            Bool b;
            if (Text.TryCast(value, out txt))
            {
 
                value = (txt ?? "").TrimEnd().ToString();
            }
            else if (Number.TryCast(value, out n))
            {
                var dec = n.ToDecimal();
                var lng = (long)dec;
                if (dec != lng)
                    value = dec;
                else value = lng;
 
            }
            else if (Date.TryCast(value, out d))
            {
                if (d == Date.Empty)
                    value = null;
                else
                {
                    value = d.ToString("YYYY-MM-DD");
                }
            }
            else if (Time.TryCast(value, out t))
            {
                value = t.ToString("HH:MM:SS");
            }
            else if (Bool.TryCast(value, out b))
                value = b.ToBoolean();
 
            _value.Add(new Val { Name = name, Value = value });
 
 
 
        }
 
        class Val
        {
            public string Name { get; set; }
            public object Value { get; set; }
        }
 
 
        public void ToWriter(ISerializedObjectWriter writer)
        {
            writer.WriteStartObject(ObjectType);
            foreach (var item in _value)
            {
                writer.WriteName(item.Name);
                var v = item.Value as ISerializedObject;
                if (v != null)
                    writer.WriteIserializedObject(v);
                else
                    writer.WriteValue(item.Value);
            }
            writer.WriteEndObject();
        }
 
        internal object Get(object name)
        {
 
            foreach (var item in _value)
            {
                if (item.Name == name)
                    return item.Value;
            }
            return null;
        }
    }
    public interface ISerializedObject
    {
        void ToWriter(ISerializedObjectWriter writer);
    }
    public interface ISerializedObjectWriter
    {
        void WriteStartArray();
        void WriteName(string name);
        void WriteValue(object value);
        void WriteIserializedObject(ISerializedObject value);
        void WriteEndArray();
        void WriteStartObject(string type);
        void WriteEndObject();
 
    }
    public class XmlISerializedObjectWriter : ISerializedObjectWriter
    {
        XmlTextWriter _writer;
        public XmlISerializedObjectWriter(XmlTextWriter writer)
        {
            _writer = writer;
        }
        public void WriteEndArray()
        {
 
        }
 
        public void WriteEndObject()
        {
            _writer.WriteEndElement();
        }
 
        public void WriteIserializedObject(ISerializedObject value)
        {
            value.ToWriter(this);
            _writer.WriteEndElement();
        }
 
        public void WriteName(string name)
        {
            _writer.WriteStartElement(name);
        }
 
        public void WriteStartArray()
        {
        }
 
        public void WriteStartObject(string type)
        {
            _writer.WriteStartElement(type);
        }
 
        public void WriteValue(object value)
        {
            _writer.WriteString(value.ToString());
            _writer.WriteEndElement();
        }
    }
    public class JsonISerializedObjectWriter : ISerializedObjectWriter
    {
        TextWriter _writer;
        public JsonISerializedObjectWriter(TextWriter writer)
        {
            _writer = writer;
        }
        public void WriteEndArray()
        {
            _writer.Write("]");
        }
 
        public void WriteEndObject()
        {
            _writer.Write("}");
        }
        bool _firstObjectInArray = true;
        bool _firstValueInObject = true;
        public void WriteIserializedObject(ISerializedObject value)
        {
            value.ToWriter(new JsonISerializedObjectWriter(_writer));
        }
 
        public void WriteName(string name)
        {
            if (_firstValueInObject)
                _firstValueInObject = false;
            else
                _writer.Write(",");
            _writer.Write("\"" + name.Replace("\"", "\\\"") + "\":");
        }
 
        public void WriteStartArray()
        {
            _writer.Write("[");
            _firstObjectInArray = true;
        }
 
        public void WriteStartObject(string type)
        {
            _firstValueInObject = true;
            if (_firstObjectInArray)
                _firstObjectInArray = false;
            else
                _writer.Write(",");
            _writer.Write("{");
        }
 
        public void WriteValue(object value)
        {
            if (value is int || value is double || value is decimal||value is long)
                _writer.Write(value.ToString());
            else
                _writer.Write("\"" + value.ToString().Replace("\\", "\\\\").Replace("\"", "\\\"").Replace("\n", "\\n").Replace("\r", "\\r") + "\"");
        }
    }
 
 
    public class CSVISerializedObjectWriter : ISerializedObjectWriter
    {
        TextWriter _writer;
        public CSVISerializedObjectWriter(TextWriter writer)
        {
            _writer = writer;
        }
        public void WriteEndArray()
        {
 
        }
 
        public void WriteEndObject()
        {
            if (_firstLine)
            {
                _writer.WriteLine(_titleLine);
                _firstLine = false;
            }
            _writer.WriteLine(_dataLine);
        }
        public void WriteIserializedObject(ISerializedObject value)
        {
            if (!_inValue)
                value.ToWriter(this);
            else
            {
                using (var sw = new StringWriter())
                {
                    value.ToWriter(new CSVISerializedObjectWriter(sw));
                    WriteValue(sw.ToString());
                }
            }
            //value.ToWriter(new CSVISerializedObjectWriter(_writer));
        }
        bool _firstLine = true;
 
        string _titleLine = "";
        string _dataLine = "";
        bool _inValue = false;
        public void WriteName(string name)
        {
            if (_titleLine.Length &gt; 0)
                _titleLine += ",";
            _titleLine += name;
            _inValue = true;
        }
 
        public void WriteStartArray()
        {
        }
 
        public void WriteStartObject(string type)
        {
            _dataLine = "";
        }
 
        public void WriteValue(object value)
        {
            if (_dataLine.Length &gt; 0)
                _dataLine += ",";
            var val = value.ToString();
            if (val.Contains(",") || val.Contains("\r\n"))
                val = "\"" + val.ToString().Replace("\"", "\"\"") + "\"";
            _dataLine += val;
            _inValue = false;
        }
    }
    public class SArray : ISerializedObject
    {
        List&lt;SObject&gt; _list = new List&lt;SObject&gt;();
 
        public SObject AddObject()
        {
            var r = new SObject();
            _list.Add(r);
            return r;
        }
 
        public string ToJson()
        {
            using (var sw = new StringWriter())
            {
                ToWriter(new JsonISerializedObjectWriter(sw));
                return sw.ToString();
            }
        }
 
 
        public void ToWriter(ISerializedObjectWriter writer)
        {
            writer.WriteStartArray();
            foreach (var item in _list)
            {
                item.ToWriter(writer);
            }
            writer.WriteEndArray();
        }
 
        public string ToXml()
        {
            using (var sw = new StringWriter())
            {
                ToWriter(new XmlISerializedObjectWriter(new XmlTextWriter(sw)));
                return sw.ToString();
            }
        }
        public string ToCsv()
        {
 
            using (var sw = new StringWriter())
            {
                ToWriter(new CSVISerializedObjectWriter(sw));
                return sw.ToString();
            }
        }
 
        internal void SortBy(string name)
        {
            _list.Sort((a, b) =&gt;
            {
                return Firefly.Box.Advanced.Comparer.Compare(a.Get(name), b.Get(name));
            });
        }
        
    }
 
}
 </code></pre>
<p><strong>SArrayResult.cs</strong></p>
<p>This file contains the definition of an MVC Action result that matches the SArray and SObject, and also the extension method required to use the “ToResult()” method.</p>
<p>It should be placed in a project with references to System.Web.MVC.</p>
<pre data-line="" class="language-csdiff line-numbers"><code>using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Web;
 
namespace Northwind.BasicAngular.Utils
{
 
    public static class SObjectHelper
    {
 
        public static SObjectResult ToResult(this ISerializedObject r)
        {
            return new SObjectResult(r);
        }
    }
 
    public class SObjectResult : System.Web.Mvc.ActionResult
    {
        ISerializedObject _r;
        public SObjectResult(ISerializedObject r)
        {
            _r = r;
        }
 
 
 
        public override void ExecuteResult(System.Web.Mvc.ControllerContext context)
        {
 
 
 
            HttpResponseBase response = context.HttpContext.Response;
            response.ContentType = "application/json";
 
            using (var sw = new StringWriter())
            {
                _r.ToWriter(new JsonISerializedObjectWriter(sw));
                response.Write(sw.ToString());
            }
 
 
        }
    }
}
 </code></pre>
<br /><hr />Help us improve, <a href="https://github.com/FireflyMigration/firefly-doc/blob/master//02-Development/03-Articles/Web-Development/13-SArray-and-SObject/index.md">Edit this page on GitHub</a></div><!-- .content -->
                
            </div><!-- .container-->
        
            <aside class="left-sidebar">
                <div class="wy-side-nav-search-ff">
                    <a href="" class="test">  <img src="assets/img/logo-big.png"></a>
                </div><div id="menuTree"</div>
            </aside><!-- .left-sidebar -->

            <aside class="right-sidebar"></aside><!-- .right-sidebar -->

        </div><!-- .middle-->



    </div>


    <script src="assets/js/mermaid.js"></script>
    <script src="assets/js/prism-start.js"></script>
    <script src="assets/js/prism-clike.js"></script>
    <script src="assets/js/prism-markup.js"></script>
    <script src="assets/js/prism-css.js"></script>
    <script src="assets/js/prism-javascript.js"></script>

    <script src="assets/js/prism-diff.js"></script>
    <script src="assets/js/prism-csdiff.js"></script>
    <script src="assets/js/prism-function.js"></script>

    <script src="assets/js/jquery-3.1.1.js"></script>
    <script src="assets/js/tree.js"></script>
    <script language="javascript">
        buildTree('menuTree', 'SArray-and-SObject.html', 'previousButton', 'nextButton');
    </script>
</body>
</html>